-- layoffs cleanup and deduplication script
-- Save this file and run against your MySQL 8+ instance (supports window functions)

-- 1) Create a staging table that matches `layoffs` and copy data into it
CREATE TABLE IF NOT EXISTS layoffs_staging LIKE layoffs;

INSERT INTO layoffs_staging
SELECT * FROM layoffs;

-- 2) Inspect duplicates using ROW_NUMBER() (note: use the date column, not the literal 'date')
WITH duplicates AS (
	SELECT *,
		ROW_NUMBER() OVER (PARTITION BY company, location, stage, funds_raised_millions, country, industry, total_laid_off, percentage_laid_off, date
											 ORDER BY date) AS rn
	FROM layoffs_staging
)
SELECT * FROM duplicates WHERE rn > 1;

-- 3) Create a cleaned staging table with proper types and a helper row number column
DROP TABLE IF EXISTS layoffs_staging2;
CREATE TABLE layoffs_staging2 (
	company TEXT,
	location TEXT,
	industry TEXT,
	total_laid_off INT DEFAULT NULL,
	percentage_laid_off VARCHAR(64),
	`date` DATE,
	stage TEXT,
	country TEXT,
	funds_raised_millions INT DEFAULT NULL,
	row_num INT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 4) Insert deduplicated rows into `layoffs_staging2`. Keep the first row per partition (rn = 1).
--    Convert textual dates using STR_TO_DATE during insert; if some formats differ, handle separately.
INSERT INTO layoffs_staging2 (company, location, industry, total_laid_off, percentage_laid_off, `date`, stage, country, funds_raised_millions, row_num)
SELECT company,
			 location,
			 industry,
			 total_laid_off,
			 percentage_laid_off,
			 STR_TO_DATE(`date`, '%m/%d/%Y') AS date_parsed,
			 stage,
			 country,
			 funds_raised_millions,
			 rn
FROM (
	SELECT *,
		ROW_NUMBER() OVER (PARTITION BY company, location, stage, funds_raised_millions, country, industry, total_laid_off, percentage_laid_off, date
											 ORDER BY date) AS rn
	FROM layoffs_staging
) AS t
WHERE rn = 1;

-- 5) Clean and normalize columns
UPDATE layoffs_staging2
SET company = TRIM(company),
		location = TRIM(location),
		stage = TRIM(stage);

-- Normalize industry values (map any 'crypto*' variants to 'crypto')
UPDATE layoffs_staging2
SET industry = 'crypto'
WHERE industry LIKE 'crypto%';

-- Trim trailing periods from country (e.g., 'United States.')
UPDATE layoffs_staging2
SET country = TRIM(TRAILING '.' FROM country)
WHERE country LIKE 'United States%';

-- 6) Remove rows that have neither total_laid_off nor percentage_laid_off
DELETE FROM layoffs_staging2
WHERE total_laid_off IS NULL
	AND (percentage_laid_off IS NULL OR TRIM(percentage_laid_off) = '');

-- 7) Normalize empty industry strings to NULL
UPDATE layoffs_staging2
SET industry = NULL
WHERE industry = '';

-- 8) Propagate industry values within the same company when some rows have NULL industry
UPDATE layoffs_staging2 t1
JOIN (
	SELECT company, MAX(industry) AS industry
	FROM layoffs_staging2
	WHERE industry IS NOT NULL AND industry <> ''
	GROUP BY company
) t2 ON t1.company = t2.company
SET t1.industry = t2.industry
WHERE t1.industry IS NULL OR t1.industry = '';

-- 9) Drop the helper column
ALTER TABLE layoffs_staging2 DROP COLUMN row_num;

-- 10) Quick inspection
SELECT * FROM layoffs_staging2 LIMIT 200;

-- 11) Top 3 companies by layoffs per year (uses window functions)
WITH Company_Year AS (
	SELECT company, YEAR(`date`) AS year, SUM(total_laid_off) AS total_laid_off
	FROM layoffs_staging2
	WHERE `date` IS NOT NULL
	GROUP BY company, YEAR(`date`)
),
Company_Year_Rank AS (
	SELECT company, year, total_laid_off,
		DENSE_RANK() OVER (PARTITION BY year ORDER BY total_laid_off DESC) AS ranking
	FROM Company_Year
)
SELECT company, year, total_laid_off, ranking
FROM Company_Year_Rank
WHERE ranking <= 3
ORDER BY year ASC, total_laid_off DESC;

-- Notes / run instructions:
-- 1) This script assumes MySQL 8+ (for window functions and DENSE_RANK()).
-- 2) Run from the mysql client: `mysql -u user -p your_database < "CLEANING AND EXPLORATORY"`
-- 3) If your `date` column uses multiple formats, handle them before or after insert with more STR_TO_DATE patterns.
-- 4) If you prefer not to keep the intermediate `layoffs_staging` table, DROP it after verification.

